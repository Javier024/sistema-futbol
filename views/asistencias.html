<!DOCTYPE html>
<html lang="es">
<head><meta charset="UTF-8"><title>Asistencias</title><link rel="stylesheet" href="../assets/css/styles.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></head>
<body><div id="app-layout"><div id="sidebar-placeholder"></div><main><header><h1>Asistencias</h1></header><div id="view-container" style="height:100%;"></div></main></div><div id="toast-container"></div>
<script src="../assets/js/common.js"></script><script>
window.addEventListener('DOMContentLoaded', () => { if(!checkAuth()) return; renderSidebar('asistencias'); loadAttView(); });
function loadAttView() {
    const cats = db.getAll('categorias');
    document.getElementById('view-container').innerHTML = `<div class="grid-2"><div class="card"><h3>Tomar</h3><div class="form-group"><label>Fecha</label><input type="date" id="ad" onchange="loadL()"></div><div class="form-group"><label>Cat</label><select id="ac" onchange="loadL()"><option value="all">Todas</option>${cats.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join('')}</select></div><div id="al" style="max-height:400px;overflow-y:auto;"></div><button class="btn btn-primary btn-block" style="margin-top:15px;" onclick="saveA()">Guardar</button></div><div class="card"><h3>Resumen</h3><div id="as"></div></div></div>`;
    document.getElementById('ad').valueAsDate = new Date(); loadL(); loadH();
}
const loadL = () => { const d = document.getElementById('ad').value; const cid = document.getElementById('ac').value; let pl = db.getAll('jugadores'); if(cid!=='all') pl=pl.filter(p=>p.id_categoria==cid); const ex = db.getAll('asistencias').filter(a=>a.fecha===d); const h = pl.map(p => { const r = ex.find(e=>e.id_jugador==p.id); const ip = r?r.estado==='P':true; return `<div class="attendance-toggle"><div style="flex:1;font-weight:600;">${p.nombres} ${p.apellidos}</div><div style="display:flex;gap:10px;"><label><input type="radio" name="a_${p.id}" value="P" ${ip?'checked':''}> P</label><label><input type="radio" name="a_${p.id}" value="A" ${!ip?'checked':''}> A</label></div></div>`; }).join(''); document.getElementById('al').innerHTML = h||'<p style="padding:10px;text-align:center;">Sin jugadores</p>'; };
const saveA = () => { const d = document.getElementById('ad').value; if(!d) return; db.getAll('asistencias').filter(a=>a.fecha===d).forEach(r=>db.delete('asistencias',r.id)); const cid = document.getElementById('ac').value; let pl = db.getAll('jugadores'); if(cid!=='all') pl=pl.filter(p=>p.id_categoria==cid); pl.forEach(p => { const rs = document.getElementsByName(`a_${p.id}`); let v='A'; for(let r of rs) if(r.checked) v=r.value; db.add('asistencias', {id_jugador:p.id, fecha:d, estado:v}); }); showToast('Guardado'); loadH(); };
const loadH = () => { const r = db.getAll('asistencias'); const g={}; r.forEach(x => { if(!g[x.fecha]) g[x.fecha]={P:0,A:0}; g[x.fecha][x.estado]++; }); const rw = Object.keys(g).sort().reverse().slice(0,5).map(d => `<tr><td>${utils.formatDate(d)}</td><td><span class="badge bg-green">${g[d].P}</span></td><td><span class="badge bg-red">${g[d].A}</span></td></tr>`).join(''); document.getElementById('as').innerHTML = `<table><thead><tr><th>Fecha</th><th>P</th><th>A</th></tr></thead><tbody>${rw||'<'+'tr><td colspan="3">Sin datos</td></tr>'}</tbody></table>`; };
</script></body></html>