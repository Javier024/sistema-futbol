<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Configuración</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div id="app-layout">
        <div id="sidebar-placeholder"></div>
        <main>
            <header><h1>Configuración del Sistema</h1></header>
            <div id="view-container"></div>
        </main>
    </div>
    <div id="toast-container"></div>
    <script src="../assets/js/common.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', async () => { 
            if(!checkAuth()) return; 
            renderSidebar('configuracion'); 
            await loadConfig(); 
        });

        async function loadConfig() {
            // Cargar datos actuales
            const conf = db.data.configuracion_sistema || { valor_mensual: 0, moneda: 'COP', nombre_escuela: '' };
            const user = db.data.usuarios ? db.data.usuarios[0] : { correo: '', hash_contrasena: '' };

            document.getElementById('view-container').innerHTML = `
                <div class="grid-2">
                    <!-- Datos de la Escuela -->
                    <div class="card">
                        <h3><i class="fas fa-school"></i> Datos de la Escuela</h3>
                        <form onsubmit="saveConfig(event)">
                            <div class="form-group">
                                <label>Nombre de la Escuela</label>
                                <input type="text" id="conf-name" value="${conf.nombre_escuela || ''}" required>
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Valor Mensual</label>
                                    <input type="number" id="conf-value" value="${conf.valor_mensual || 0}" required>
                                </div>
                                <div class="form-group">
                                    <label>Moneda</label>
                                    <select id="conf-currency">
                                        <option value="COP" ${conf.moneda==='COP'?'selected':''}>Peso Colombiano (COP)</option>
                                        <option value="USD" ${conf.moneda==='USD'?'selected':''}>Dólar (USD)</option>
                                        <option value="EUR" ${conf.moneda==='EUR'?'selected':''}>Euro (EUR)</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Actualizar Datos</button>
                        </form>
                    </div>

                    <!-- Seguridad y Backup -->
                    <div class="card">
                        <h3><i class="fas fa-shield-alt"></i> Seguridad</h3>
                        <form onsubmit="saveUser(event)">
                            <div class="form-group"><label>Correo Admin</label><input type="email" id="user-email" value="${user.correo}"></div>
                            <div class="form-group"><label>Nueva Contraseña</label><input type="password" id="user-pass" placeholder="Dejar en blanco para no cambiar"></div>
                            <button type="submit" class="btn btn-secondary btn-block">Actualizar Credenciales</button>
                        </form>
                        
                        <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border);">
                        
                        <h3><i class="fas fa-database"></i> Respaldo de Datos</h3>
                        <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:10px;">Descarga una copia de toda la base de datos local (caché).</p>
                        <button class="btn btn-accent btn-block" onclick="downloadBackup()">
                            <i class="fas fa-download"></i> Descargar Backup (.json)
                        </button>
                    </div>
                </div>
            `;
        }

        const saveConfig = async (e) => {
            e.preventDefault();
            const data = {
                nombre_escuela: document.getElementById('conf-name').value,
                valor_mensual: document.getElementById('conf-value').value,
                moneda: document.getElementById('conf-currency').value
            };
            await db.update('configuracion_sistema', 1, data);
            showToast('Configuración actualizada', 'success');
        };

        const saveUser = async (e) => {
            e.preventDefault();
            // Nota: La actualización de usuario requeriría un endpoint PUT en la API real
            showToast('Credenciales actualizadas (Simulado)', 'success');
        };

        const downloadBackup = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db.data));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "efusa_backup_" + new Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast('Backup descargado', 'success');
        };
    </script>
</body>
</html>