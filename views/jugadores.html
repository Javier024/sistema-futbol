<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Jugadores - Futbol Manager</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div id="app-layout"><div id="sidebar-placeholder"></div><main><header><h1>Gestión de Jugadores</h1></header><div id="view-container" style="flex:1;"></div></main></div>
    <div id="modal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><h3 id="modal-title">Título</h3><button onclick="closeModal()" class="btn btn-sm btn-secondary"><i class="fas fa-times"></i></button></div><div id="modal-content"></div></div></div>
    <div id="toast-container"></div>
    <script src="../assets/js/common.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => { if(!checkAuth()) return; renderSidebar('jugadores'); loadPlayers(); });
        function loadPlayers() {
            const players = db.getAll('jugadores');
            const rows = players.map(p => { const cat = db.getById('categorias', p.id_categoria); const status = finance.getPlayerStatus(p.id); let badgeClass = status.status === 'paid' ? 'bg-green' : (status.status === 'partial' ? 'bg-yellow' : 'bg-red'); return `<tr><td>${p.nombres} ${p.apellidos}</td><td>${utils.getAge(p.fecha_nacimiento)}</td><td>${cat ? cat.nombre : 'N/A'}</td><td>${p.telefono}</td><td><span class="badge ${badgeClass}">${status.status.toUpperCase()}</span></td><td><button class="btn btn-sm btn-secondary" onclick="editPlayer(${p.id})"><i class="fas fa-edit"></i></button> <a href="pagos.html" class="btn btn-sm btn-primary" onclick="sessionStorage.setItem('payPlayerId', ${p.id})"><i class="fas fa-dollar-sign"></i></a> <button class="btn btn-sm btn-accent" onclick="openMedicalHistory(${p.id})"><i class="fas fa-notes-medical"></i></button></td></tr>`; }).join('');
            document.getElementById('view-container').innerHTML = `<div class="card" style="flex:1;"><div style="display:flex; justify-content:space-between; margin-bottom:15px;"><input type="text" placeholder="Buscar..." style="max-width:300px;" onkeyup="filterTable('players-table', this.value)"><button class="btn btn-primary" onclick="newPlayerModal()"><i class="fas fa-plus"></i> Nuevo</button></div><div class="table-container"><table id="players-table"><thead><tr><th>Nombre</th><th>Edad</th><th>Cat.</th><th>Teléfono</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>${rows || '<tr><td colspan="6" style="text-align:center">Sin datos</td></tr>'}</tbody></table></div></div>`;
        }
        const newPlayerModal = () => { const catOptions = db.getAll('categorias').map(c => `<option value="${c.id}">${c.nombre}</option>`).join(''); openModal('Nuevo Jugador', `<form onsubmit="savePlayer(event)"><div class="grid-2"><div class="form-group"><label>Nombres</label><input type="text" id="p-name" required></div><div class="form-group"><label>Apellidos</label><input type="text" id="p-lastname" required></div></div><div class="grid-2"><div class="form-group"><label>Fecha Nac.</label><input type="date" id="p-dob" required onchange="autoSetCategory()"></div><div class="form-group"><label>Teléfono</label><input type="tel" id="p-phone" required></div></div><div class="grid-2"><div class="form-group"><label>Acudiente</label><input type="text" id="p-guardian" required></div><div class="form-group"><label>Tel. Acudiente</label><input type="tel" id="p-guardian-phone" required></div></div><div class="form-group"><label>Categoría</label><select id="p-cat" required>${catOptions}</select></div><button type="submit" class="btn btn-primary btn-block">Guardar</button></form>`); };
        const autoSetCategory = () => { const dob = document.getElementById('p-dob').value; if(!dob) return; const cat = utils.getCategory(utils.getAge(dob)); if(cat) document.getElementById('p-cat').value = cat.id; };
        const savePlayer = (e) => { e.preventDefault(); let acudiente = db.getAll('acudientes').find(a => a.telefono === document.getElementById('p-guardian-phone').value); if(!acudiente) acudiente = db.add('acudientes', { nombre: document.getElementById('p-guardian').value, telefono: document.getElementById('p-guardian-phone').value }); db.add('jugadores', { nombres: document.getElementById('p-name').value, apellidos: document.getElementById('p-lastname').value, fecha_nacimiento: document.getElementById('p-dob').value, telefono: document.getElementById('p-phone').value, id_categoria: document.getElementById('p-cat').value, id_acudiente: acudiente.id, tipo_sangre: 'O+' }); closeModal(); showToast('Guardado'); loadPlayers(); };
        const editPlayer = (id) => { const p = db.getById('jugadores', id); if(!p) return; newPlayerModal(); setTimeout(() => { document.getElementById('p-name').value = p.nombres; document.getElementById('p-lastname').value = p.apellidos; document.getElementById('p-dob').value = p.fecha_nacimiento; document.getElementById('p-phone').value = p.telefono; document.getElementById('p-cat').value = p.id_categoria; const acu = db.getById('acudientes', p.id_acudiente); if(acu){ document.getElementById('p-guardian').value = acu.nombre; document.getElementById('p-guardian-phone').value = acu.telefono; } document.querySelector('#modal-content form').onsubmit = (ev) => { ev.preventDefault(); db.update('jugadores', id, { nombres: document.getElementById('p-name').value, apellidos: document.getElementById('p-lastname').value, fecha_nacimiento: document.getElementById('p-dob').value, telefono: document.getElementById('p-phone').value, id_categoria: document.getElementById('p-cat').value }); closeModal(); showToast('Actualizado'); loadPlayers(); }; }, 100); };
        const openMedicalHistory = (playerId) => { const p = db.getById('jugadores', playerId); const history = db.getAll('historial_medico').filter(h => h.id_jugador == playerId).sort((a,b) => new Date(b.fecha) - new Date(a.fecha)); const rows = history.map(h => `<tr><td>${utils.formatDate(h.fecha)}</td><td><span class="badge ${h.tipo==='Alergia'?'bg-red':'bg-blue'}">${h.tipo}</span></td><td>${h.descripcion}</td><td><button class="btn btn-sm btn-danger" onclick="db.delete('historial_medico', ${h.id}); openMedicalHistory(${playerId});"><i class="fas fa-trash"></i></button></td></tr>`).join(''); openModal(`Médico: ${p.nombres}`, `<div style="margin-bottom:20px;"><h4>Registrar</h4><div style="display:flex; gap:10px;"><select id="med-type"><option value="Lesión">Lesión</option><option value="Enfermedad">Enfermedad</option><option value="Alergia">Alergia</option></select><input type="text" id="med-desc" placeholder="Desc" style="flex:1;"><input type="date" id="med-date"><button class="btn btn-primary" onclick="db.add('historial_medico', {id_jugador:${playerId}, tipo:document.getElementById('med-type').value, descripcion:document.getElementById('med-desc').value, fecha:document.getElementById('med-date').value}); openMedicalHistory(${playerId});"><i class="fas fa-plus"></i></button></div></div><table><thead><tr><th>Fecha</th><th>Tipo</th><th>Desc</th><th></th></tr></thead><tbody>${rows||'<tr><td colspan="4">Sin datos</td></tr>'}</tbody></table>`); };
    </script>
</body>
</html>